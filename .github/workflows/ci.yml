name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18.20.8'
  NPM_VERSION: '10.8.2'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install specific npm version
        run: npm install -g npm@${{ env.NPM_VERSION }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup test environment variables
        run: |
          cat > .env << EOF
          SLACK_USER_OAUTH_TOKEN=xoxp-test-token
          SLACK_BOT_USER_OAUTH_TOKEN=xoxb-test-token
          SLACK_BOT_USER_NAME=test-bot
          ANTHROPIC_API_KEY=sk-ant-test-key
          GH_PERSONAL_ACCESS_TOKEN=ghp_test_token
          REDMINE_API_KEY=test-redmine-key
          REDASH_API_KEY=test-redash-key
          GROWI_API_TOKEN=test-growi-token
          GROWI_COOKIE=test-cookie
          GOOGLE_REDIRECT_URI=http://localhost:8080/oauth2callback
          GOOGLE_CREDENTIALS_JSON='{"installed":{"client_id":"test","project_id":"test","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_secret":"test","redirect_uris":["http://localhost"]}}'
          EOF

      - name: Run Prettier check
        run: npm run format:check
      
      - name: Run build
        run: npm run build
      
      - name: Clear Jest cache
        run: npx jest --clearCache
      
      - name: Run tests
        run: npm test
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ” CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Prettier** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tests** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

